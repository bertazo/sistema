<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bertazo | Sistema de Gest√£o</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root { --bordo: #800020; --gold: #b8860b; --bg: #f0f2f5; --text: #333; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; min-height: 100vh; }
        
        /* UTILIT√ÅRIOS */
        .hidden { display: none !important; }
        .btn { background: var(--bordo); color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s; width: 100%; }
        .btn:hover { background: #5a0016; }
        .btn-outline { background: transparent; border: 1px solid white; color: white; width: auto; }
        input, select, textarea { width: 100%; padding: 10px; margin: 5px 0 15px 0; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-family: inherit; }
        
        /* TELA DE LOGIN */
        #login-flow { position: fixed; inset: 0; background: var(--bordo); display: flex; justify-content: center; align-items: center; z-index: 2000; }
        .login-box { background: white; padding: 40px; border-radius: 12px; width: 100%; max-width: 350px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        .login-logo { font-size: 24px; font-weight: bold; color: var(--bordo); margin-bottom: 5px; letter-spacing: 2px; }
        .login-sub { font-size: 14px; color: #666; margin-bottom: 25px; }
        #login-msg { color: #d32f2f; font-size: 13px; margin-top: 10px; min-height: 20px; }

        /* APLICA√á√ÉO PRINCIPAL */
        header { background: var(--bordo); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-bottom: 4px solid var(--gold); }
        nav { background: white; padding: 10px; display: flex; justify-content: center; gap: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        nav button { background: none; border: none; padding: 10px 20px; color: #666; font-weight: bold; cursor: pointer; border-radius: 4px; }
        nav button.active { background: #fff0f3; color: var(--bordo); }

        .container { max-width: 1200px; margin: 30px auto; padding: 0 20px; flex: 1; }
        .card { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; border-top: 4px solid var(--bordo); }
        
        /* BI & KPIS */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .kpi-box { background: white; padding: 20px; border-radius: 8px; text-align: center; border-bottom: 3px solid var(--gold); }
        .kpi-val { font-size: 24px; font-weight: bold; color: var(--bordo); margin-top: 5px; }
        
        /* LISTAS */
        .cli-item { background: white; border-left: 5px solid var(--gold); padding: 15px; margin-bottom: 10px; border-radius: 4px; position: relative; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .cli-actions { position: absolute; top: 15px; right: 15px; }
        .badge { background: #eee; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; color: #555; text-transform: uppercase; }
        
        /* Mobile Responsividade */
        @media(max-width: 600px) { .grid-form { grid-template-columns: 1fr !important; } }
        .grid-form { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    </style>
</head>
<body>

    <div id="login-flow">
        <div class="login-box">
            <div class="login-logo">BERTAZO</div>
            <div class="login-sub">Gest√£o Estrat√©gica & BI</div>
            
            <form onsubmit="event.preventDefault(); handleLogin();">
                <input type="email" id="email" placeholder="E-mail" required>
                <input type="password" id="password" placeholder="Senha" required>
                <button type="submit" id="btn-login" class="btn">ACESSAR SISTEMA</button>
            </form>
            
            <div id="login-msg"></div>
        </div>
    </div>

    <div id="app-flow" class="hidden">
        <header>
            <div><strong>BERTAZO</strong> | PAINEL</div>
            <button onclick="handleLogout()" class="btn btn-outline" style="font-size: 12px; padding: 5px 15px;">SAIR</button>
        </header>

        <nav>
            <button id="nav-bi" class="active" onclick="switchTab('bi')">DASHBOARD BI</button>
            <button id="nav-cli" onclick="switchTab('cli')">CLIENTES</button>
            <button id="nav-fat" onclick="switchTab('fat')">FATURAMENTO</button>
        </nav>

        <div class="container">
            
            <section id="tab-bi">
                <div class="kpi-grid">
                    <div class="kpi-box">
                        <small>FATURAMENTO</small>
                        <div id="kpi-total" class="kpi-val">R$ 0,00</div>
                    </div>
                    <div class="kpi-box">
                        <small>TICKET M√âDIO</small>
                        <div id="kpi-ticket" class="kpi-val">R$ 0,00</div>
                    </div>
                    <div class="kpi-box">
                        <small>M√äS REFER√äNCIA</small><br>
                        <input type="month" id="bi-mes" onchange="loadDashboard()" style="width: auto; margin: 5px 0 0 0; border: none; font-weight: bold; color: var(--bordo);">
                    </div>
                </div>

                <div class="card" style="padding: 15px;">
                    <label style="font-size: 12px; font-weight: bold;">FILTRAR GR√ÅFICOS POR REPRESENTADA:</label>
                    <select id="bi-rep-filter" onchange="loadDashboard()" style="margin-bottom: 0;">
                        <option value="">Todas as Representadas</option>
                        <option>PLAXMETAL PR</option><option>PLAXMETAL MS/MT</option>
                        <option>LUNASA</option><option>GEBB</option><option>ARIAM</option>
                    </select>
                </div>

                <div class="card">
                    <canvas id="chart-evolution" height="80"></canvas>
                </div>
            </section>

            <section id="tab-cli" class="hidden">
                <div class="card">
                    <h3 style="margin-top:0; color:var(--bordo)">Nova Ficha de Cliente</h3>
                    <div class="grid-form">
                        <input type="text" id="c-nome" placeholder="Raz√£o Social *">
                        <input type="text" id="c-cnpj" placeholder="CNPJ / CPF">
                    </div>
                    <div class="grid-form">
                        <select id="c-rep">
                            <option>PLAXMETAL PR</option><option>PLAXMETAL MS/MT</option>
                            <option>LUNASA</option><option>GEBB</option><option>ARIAM</option>
                        </select>
                        <input type="text" id="c-contato" placeholder="Nome do Contato">
                    </div>
                    <div class="grid-form">
                        <input type="text" id="c-whats" placeholder="WhatsApp / Telefone">
                        <input type="text" id="c-end" placeholder="Cidade / Estado">
                    </div>
                    <textarea id="c-obs" placeholder="Observa√ß√µes Gerais..." rows="3"></textarea>
                    <button class="btn" onclick="saveClient()">SALVAR FICHA</button>
                </div>

                <div class="card" style="background: #fafafa; border: 1px solid #eee;">
                    <input type="text" id="c-search" placeholder="üîç Buscar cliente..." oninput="renderClients()" style="margin-bottom: 0;">
                </div>

                <div id="list-clients"></div>
            </section>

            <section id="tab-fat" class="hidden">
                <div class="card">
                    <h3 style="margin-top:0; color:var(--bordo)">Lan√ßar Venda</h3>
                    <div class="grid-form">
                        <input type="date" id="v-data">
                        <input type="number" id="v-valor" placeholder="Valor R$">
                    </div>
                    <div class="grid-form">
                        <input type="text" id="v-cliente" placeholder="Nome do Cliente">
                        <input type="text" id="v-nf" placeholder="Nota Fiscal">
                    </div>
                    <select id="v-rep">
                        <option>PLAXMETAL PR</option><option>PLAXMETAL MS/MT</option>
                        <option>LUNASA</option><option>GEBB</option><option>ARIAM</option>
                    </select>
                    <button class="btn" onclick="saveSale()">REGISTRAR VENDA</button>
                </div>

                <div class="card">
                    <div id="list-sales"></div>
                </div>
            </section>

        </div>
    </div>

    <script>
        // --- 1. CONFIGURA√á√ÉO (PREENCHA AQUI) ---
        const SUPABASE_URL = "https://abjqrorlzkmbtiqoooxb.supabase.co";
        const SUPABASE_KEY = "sb_publishable_89VYMYncTckOQdDyiKXpuQ_AewcuCE4";
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Vari√°veis Globais
        let chartInstance = null;
        let clientsCache = [];

        // --- 2. SISTEMA DE LOGIN (AUTH) ---
        
        // Ouve se o usu√°rio entrou ou saiu
        sb.auth.onAuthStateChange((event, session) => {
            if (session) {
                // Usu√°rio logado: Esconde login, Mostra app
                document.getElementById('login-flow').classList.add('hidden');
                document.getElementById('app-flow').classList.remove('hidden');
                initApp(); // Carrega os dados
            } else {
                // Usu√°rio deslogado: Mostra login, Esconde app
                document.getElementById('login-flow').classList.remove('hidden');
                document.getElementById('app-flow').classList.add('hidden');
            }
        });

        async function handleLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const msg = document.getElementById('login-msg');
            const btn = document.getElementById('btn-login');

            btn.disabled = true;
            btn.innerText = "Verificando...";
            msg.innerText = "";

            const { data, error } = await sb.auth.signInWithPassword({ email, password });

            if (error) {
                btn.disabled = false;
                btn.innerText = "ACESSAR SISTEMA";
                msg.innerText = "Erro: Verifique e-mail e senha.";
                console.error(error);
            }
            // Se der certo, o onAuthStateChange vai lidar com a troca de tela automaticamente
        }

        async function handleLogout() {
            await sb.auth.signOut();
            window.location.reload();
        }

        // --- 3. INICIALIZA√á√ÉO E DADOS ---

        function initApp() {
            document.getElementById('bi-mes').value = new Date().toISOString().slice(0, 7);
            document.getElementById('v-data').valueAsDate = new Date();
            loadClients();
            loadSales();
            loadDashboard();
        }

        function switchTab(tabName) {
            // Esconde todas as se√ß√µes
            document.querySelectorAll('section').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('nav button').forEach(el => el.classList.remove('active'));
            
            // Mostra a escolhida
            document.getElementById('tab-' + tabName).classList.remove('hidden');
            document.getElementById('nav-' + tabName).classList.add('active');
        }

        // --- 4. FUN√á√ïES DE CLIENTES ---
        
        async function saveClient() {
            const nome = document.getElementById('c-nome').value;
            if(!nome) return alert("O nome da Raz√£o Social √© obrigat√≥rio.");

            const { error } = await sb.from('clientes').insert([{
                nome: nome,
                cnpj: document.getElementById('c-cnpj').value,
                representada: document.getElementById('c-rep').value,
                contato: document.getElementById('c-contato').value,
                whatsapp: document.getElementById('c-whats').value,
                endereco: document.getElementById('c-end').value,
                observacoes: document.getElementById('c-obs').value
            }]);

            if(error) alert("Erro ao salvar: " + error.message);
            else {
                alert("Cliente salvo com sucesso!");
                // Limpa campos
                document.querySelectorAll('#tab-cli input, #tab-cli textarea').forEach(i => i.value = '');
                loadClients();
            }
        }

        async function loadClients() {
            const { data } = await sb.from('clientes').select('*').order('nome');
            clientsCache = data || [];
            renderClients();
        }

        function renderClients() {
            const term = document.getElementById('c-search').value.toLowerCase();
            const list = document.getElementById('list-clients');
            list.innerHTML = "";

            const filtered = clientsCache.filter(c => c.nome.toLowerCase().includes(term));

            filtered.forEach(c => {
                list.innerHTML += `
                    <div class="cli-item">
                        <div class="cli-actions">
                            <button onclick="deleteItem('clientes', '${c.id}')" style="color:red; border:none; background:none; cursor:pointer; font-size:18px;">&times;</button>
                        </div>
                        <span class="badge">${c.representada}</span>
                        <h3 style="margin: 5px 0; color: var(--bordo);">${c.nome}</h3>
                        <div style="font-size: 13px; color: #555; line-height: 1.6;">
                            <strong>CNPJ:</strong> ${c.cnpj || '-'} <br>
                            <strong>Contato:</strong> ${c.contato || '-'} | <strong>WhatsApp:</strong> ${c.whatsapp || '-'} <br>
                            <strong>Local:</strong> ${c.endereco || '-'}
                        </div>
                        ${c.observacoes ? `<div style="margin-top:8px; background:#f9f9f9; padding:8px; border-radius:4px; font-size:12px; color:#666;">üìù ${c.observacoes}</div>` : ''}
                    </div>
                `;
            });
        }

        // --- 5. FUN√á√ïES DE VENDAS E BI ---

        async function saveSale() {
            const valor = document.getElementById('v-valor').value;
            const cliente = document.getElementById('v-cliente').value;
            
            if(!valor || !cliente) return alert("Preencha Cliente e Valor.");

            await sb.from('vendas').insert([{
                data_venda: document.getElementById('v-data').value,
                cliente_nome: cliente,
                representada: document.getElementById('v-rep').value,
                valor: parseFloat(valor),
                nf: document.getElementById('v_nf').value
            }]);

            // Limpa parciais
            document.getElementById('v-valor').value = "";
            document.getElementById('v-nf').value = "";
            loadSales();
            loadDashboard();
        }

        async function loadSales() {
            // Carrega apenas as √∫ltimas 50 vendas para a lista de faturamento n√£o ficar pesada
            const { data } = await sb.from('vendas').select('*').order('data_venda', {ascending: false}).limit(50);
            const list = document.getElementById('list-sales');
            
            let html = '<table style="width:100%; border-collapse:collapse; font-size:14px;">';
            html += '<tr style="background:#eee; text-align:left;"> <th style="padding:10px;">Data</th> <th>Cliente</th> <th>Valor</th> <th></th> </tr>';
            
            data?.forEach(v => {
                html += `
                    <tr style="border-bottom:1px solid #eee;">
                        <td style="padding:10px;">${v.data_venda.split('-').reverse().join('/')}</td>
                        <td>${v.cliente_nome}<br><small style="color:#888">${v.representada}</small></td>
                        <td style="font-weight:bold; color:var(--bordo)">R$ ${v.valor.toLocaleString('pt-BR')}</td>
                        <td style="text-align:right;"><button onclick="deleteItem('vendas', '${v.id}')" style="color:red; border:none; background:none; cursor:pointer;">&times;</button></td>
                    </tr>
                `;
            });
            list.innerHTML = html + '</table>';
        }

        async function loadDashboard() {
            const mes = document.getElementById('bi-mes').value;
            const repFilter = document.getElementById('bi-rep-filter').value;
            
            // Query base: Pega o m√™s inteiro
            let query = sb.from('vendas').select('*')
                .gte('data_venda', `${mes}-01`)
                .lte('data_venda', `${mes}-31`);
            
            // Aplica filtro de representada se selecionado
            if(repFilter) {
                query = query.eq('representada', repFilter);
            }

            const { data } = await query;
            if(!data) return;

            // C√°lculos
            const total = data.reduce((acc, curr) => acc + curr.valor, 0);
            const ticket = data.length > 0 ? total / data.length : 0;

            document.getElementById('kpi-total').innerText = total.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
            document.getElementById('kpi-ticket').innerText = ticket.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});

            // Gr√°fico
            const dias = {};
            data.forEach(v => {
                dias[v.data_venda] = (dias[v.data_venda] || 0) + v.valor;
            });
            
            // Ordenar dias
            const sortedDias = Object.keys(dias).sort();
            
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(document.getElementById('chart-evolution'), {
                type: 'line',
                data: {
                    labels: sortedDias.map(d => d.split('-')[2]), // Apenas o dia
                    datasets: [{
                        label: 'Vendas (R$)',
                        data: sortedDias.map(d => dias[d]),
                        borderColor: '#800020',
                        backgroundColor: 'rgba(128, 0, 32, 0.1)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });
        }

        async function deleteItem(table, id) {
            if(confirm("Tem certeza que deseja excluir?")) {
                await sb.from(table).delete().eq('id', id);
                // Recarrega tudo para garantir sincronia
                initApp();
            }
        }
    </script>
</body>
</html>