<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bertazo | Sistema de Gest√£o</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üíº</text></svg>">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root { --bordo: #800020; --gold: #b8860b; --bg: #f0f2f5; --text: #333; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; min-height: 100vh; }
        
        .hidden { display: none !important; }
        .btn { background: var(--bordo); color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: 600; width: 100%; transition: 0.2s; }
        .btn:hover { background: #5a0016; }
        input, select, textarea { width: 100%; padding: 12px; margin: 5px 0 15px 0; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        
        /* LOGIN */
        #login-screen { position: fixed; inset: 0; background: var(--bordo); display: flex; justify-content: center; align-items: center; z-index: 2000; }
        .login-box { background: white; padding: 40px; border-radius: 12px; width: 90%; max-width: 350px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        
        /* APP */
        header { background: var(--bordo); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 4px solid var(--gold); }
        nav { background: white; padding: 10px; display: flex; justify-content: center; gap: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        nav button { background: none; border: none; padding: 10px 15px; color: #666; font-weight: bold; cursor: pointer; border-radius: 4px; }
        nav button.active { background: #fff0f3; color: var(--bordo); border-bottom: 2px solid var(--bordo); }

        .container { max-width: 1200px; margin: 20px auto; padding: 0 20px; flex: 1; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; border-top: 3px solid var(--bordo); }
        
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .kpi-box { background: white; padding: 20px; border-radius: 8px; text-align: center; border-bottom: 3px solid var(--gold); }
        
        .grid-form { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        @media(max-width: 600px) { .grid-form { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2 style="color:var(--bordo); margin:0 0 10px 0;">BERTAZO</h2>
            <p style="color:#666; font-size:14px;">Gest√£o Estrat√©gica</p>
            <input type="email" id="email" placeholder="E-mail">
            <input type="password" id="password" placeholder="Senha">
            <button class="btn" onclick="fazerLogin()" id="btn-entrar">ENTRAR</button>
            <p id="msg-erro" style="color:red; font-size:12px; margin-top:10px;"></p>
        </div>
    </div>

    <div id="app" class="hidden">
        <header>
            <div style="font-weight:bold; letter-spacing:1px;">BERTAZO</div>
            <button onclick="sair()" style="background:transparent; border:1px solid white; color:white; padding:5px 15px; border-radius:4px; cursor:pointer;">SAIR</button>
        </header>

        <nav>
            <button id="nav-bi" class="active" onclick="mudarAba('bi')">DASHBOARD</button>
            <button id="nav-cli" onclick="mudarAba('cli')">CLIENTES</button>
            <button id="nav-fat" onclick="mudarAba('fat')">FATURAMENTO</button>
        </nav>

        <div class="container">
            
            <section id="tab-bi">
                <div class="kpi-grid">
                    <div class="kpi-box">
                        <small style="color:#888; font-weight:bold;">FATURAMENTO</small>
                        <div id="kpi-total" style="font-size:24px; font-weight:bold; color:var(--bordo);">R$ 0,00</div>
                    </div>
                    <div class="kpi-box">
                        <small style="color:#888; font-weight:bold;">M√äS REFER√äNCIA</small><br>
                        <input type="month" id="bi-mes" onchange="carregarBI()" style="width:auto; margin:5px 0 0 0; border:none; font-weight:bold; color:var(--bordo);">
                    </div>
                </div>
                <div class="card">
                    <label style="font-size:12px; font-weight:bold;">FILTRAR REPRESENTADA:</label>
                    <select id="bi-rep" onchange="carregarBI()" style="margin-bottom:0;">
                        <option value="">Todas</option>
                        <option>PLAXMETAL PR</option><option>PLAXMETAL MS/MT</option>
                        <option>LUNASA</option><option>GEBB</option><option>ARIAM</option>
                    </select>
                </div>
                <div class="card">
                    <canvas id="grafico-vendas"></canvas>
                </div>
            </section>

            <section id="tab-cli" class="hidden">
                <div class="card">
                    <h3>Novo Cliente (Ficha Completa)</h3>
                    <div class="grid-form">
                        <input type="text" id="c-nome" placeholder="Raz√£o Social *">
                        <input type="text" id="c-cnpj" placeholder="CNPJ">
                    </div>
                    <div class="grid-form">
                        <select id="c-rep">
                            <option>PLAXMETAL PR</option><option>PLAXMETAL MS/MT</option>
                            <option>LUNASA</option><option>GEBB</option><option>ARIAM</option>
                        </select>
                        <input type="text" id="c-contato" placeholder="Contato">
                    </div>
                    <div class="grid-form">
                        <input type="text" id="c-whats" placeholder="WhatsApp">
                        <input type="text" id="c-end" placeholder="Endere√ßo / Cidade">
                    </div>
                    <textarea id="c-obs" placeholder="Observa√ß√µes..." rows="2"></textarea>
                    <button class="btn" onclick="salvarCliente()">SALVAR FICHA</button>
                </div>
                <div id="lista-clientes"></div>
            </section>

            <section id="tab-fat" class="hidden">
                <div class="card">
                    <h3>Lan√ßar Venda</h3>
                    <div class="grid-form">
                        <input type="date" id="v-data">
                        <input type="number" id="v-valor" placeholder="Valor (R$)">
                    </div>
                    <div class="grid-form">
                        <input type="text" id="v-cli" placeholder="Nome do Cliente">
                        <input type="text" id="v-nf" placeholder="Nota Fiscal">
                    </div>
                    <select id="v-rep">
                        <option>PLAXMETAL PR</option><option>PLAXMETAL MS/MT</option>
                        <option>LUNASA</option><option>GEBB</option><option>ARIAM</option>
                    </select>
                    <button class="btn" onclick="salvarVenda()">REGISTRAR VENDA</button>
                </div>
                <div class="card">
                    <table style="width:100%; border-collapse:collapse;" id="tabela-vendas"></table>
                </div>
            </section>

        </div>
    </div>

    <script>
        // --- CONFIGURA√á√ÉO ---
        const SB_URL = "https://bertazo.github.io/sistema/";
        const SB_KEY = "Ssb_publishable_89VYMYncTckOQdDyiKXpuQ_AewcuCE4";
        const sb = supabase.createClient(SB_URL, SB_KEY);
        let chartInstance = null;

        // --- SISTEMA DE LOGIN INTELIGENTE ---
        // Verifica se j√° existe login ao abrir a p√°gina
        window.onload = async () => {
            const { data: { session } } = await sb.auth.getSession();
            if (session) {
                mostrarApp();
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
            }
        };

        async function fazerLogin() {
            const btn = document.getElementById('btn-entrar');
            const msg = document.getElementById('msg-erro');
            btn.innerText = "Entrando...";
            btn.disabled = true;

            const { data, error } = await sb.auth.signInWithPassword({
                email: document.getElementById('email').value,
                password: document.getElementById('password').value
            });

            if (error) {
                msg.innerText = "Erro: " + error.message;
                btn.innerText = "ENTRAR";
                btn.disabled = false;
            } else {
                mostrarApp();
            }
        }

        async function sair() {
            await sb.auth.signOut();
            location.reload();
        }

        function mostrarApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            // Inicia valores padr√£o
            document.getElementById('bi-mes').value = new Date().toISOString().slice(0, 7);
            document.getElementById('v-data').valueAsDate = new Date();
            carregarBI();
            carregarClientes();
            carregarVendas();
        }

        // --- FUN√á√ïES DE VENDAS ---
        async function salvarVenda() {
            const valor = document.getElementById('v-valor').value;
            const cliente = document.getElementById('v-cli').value;

            if (!valor || !cliente) return alert("Preencha Valor e Cliente!");

            const { error } = await sb.from('vendas').insert([{
                data_venda: document.getElementById('v-data').value,
                cliente_nome: cliente,
                valor: parseFloat(valor),
                nf: document.getElementById('v-nf').value,
                representada: document.getElementById('v-rep').value
            }]);

            if (error) {
                alert("Erro ao salvar venda: " + error.message);
                console.error(error); // Mostra o erro real no console se houver
            } else {
                alert("Venda Registrada!");
                document.getElementById('v-valor').value = '';
                document.getElementById('v-nf').value = '';
                carregarVendas();
                carregarBI();
            }
        }

        async function carregarVendas() {
            const { data } = await sb.from('vendas').select('*').order('data_venda', {ascending: false}).limit(20);
            const tabela = document.getElementById('tabela-vendas');
            tabela.innerHTML = `
                <tr style="background:#eee; text-align:left;">
                    <th style="padding:10px">Data</th><th>Cliente</th><th>Valor</th><th></th>
                </tr>
            `;
            data?.forEach(v => {
                tabela.innerHTML += `
                    <tr style="border-bottom:1px solid #ddd">
                        <td style="padding:10px">${v.data_venda.split('-').reverse().join('/')}</td>
                        <td>${v.cliente_nome}<br><small>${v.representada}</small></td>
                        <td style="color:var(--bordo); font-weight:bold">R$ ${v.valor.toLocaleString('pt-BR')}</td>
                        <td><button onclick="deletar('vendas','${v.id}')" style="color:red; border:none; background:none; cursor:pointer">X</button></td>
                    </tr>
                `;
            });
        }

        // --- FUN√á√ïES DE CLIENTES ---
        async function salvarCliente() {
            const nome = document.getElementById('c-nome').value;
            if(!nome) return alert("Preencha a Raz√£o Social");

            const { error } = await sb.from('clientes').insert([{
                nome: nome,
                cnpj: document.getElementById('c-cnpj').value,
                representada: document.getElementById('c-rep').value,
                contato: document.getElementById('c-contato').value,
                whatsapp: document.getElementById('c-whats').value,
                endereco: document.getElementById('c-end').value,
                observacoes: document.getElementById('c-obs').value
            }]);

            if(error) alert("Erro: " + error.message);
            else {
                alert("Cliente Salvo!");
                document.querySelectorAll('#tab-cli input').forEach(i => i.value = '');
                carregarClientes();
            }
        }

        async function carregarClientes() {
            const { data } = await sb.from('clientes').select('*').order('nome');
            const lista = document.getElementById('lista-clientes');
            lista.innerHTML = '';
            data?.forEach(c => {
                lista.innerHTML += `
                    <div class="card" style="border-left:5px solid var(--gold); border-top:none;">
                        <div style="display:flex; justify-content:space-between">
                            <strong>${c.nome}</strong>
                            <button onclick="deletar('clientes','${c.id}')" style="color:red; border:none; background:none; cursor:pointer">üóëÔ∏è</button>
                        </div>
                        <small style="background:#eee; padding:2px 5px; border-radius:4px;">${c.representada}</small>
                        <p style="font-size:13px; color:#555; margin:5px 0">
                            üìû ${c.contato || '-'} | ${c.whatsapp || '-'}<br>
                            üìç ${c.endereco || '-'}
                        </p>
                    </div>
                `;
            });
        }

        // --- BI E UTILIT√ÅRIOS ---
        async function carregarBI() {
            const mes = document.getElementById('bi-mes').value;
            const rep = document.getElementById('bi-rep').value;
            let query = sb.from('vendas').select('*').gte('data_venda', `${mes}-01`).lte('data_venda', `${mes}-31`);
            
            if(rep) query = query.eq('representada', rep);

            const { data } = await query;
            const total = data?.reduce((acc, v) => acc + v.valor, 0) || 0;
            
            document.getElementById('kpi-total').innerText = total.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});

            // Gr√°fico
            const dias = {};
            data?.forEach(v => dias[v.data_venda] = (dias[v.data_venda]||0) + v.valor);
            const labels = Object.keys(dias).sort().map(d => d.split('-')[2]);
            const valores = Object.keys(dias).sort().map(d => dias[d]);

            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(document.getElementById('grafico-vendas'), {
                type: 'line',
                data: { labels: labels, datasets: [{ label: 'Vendas', data: valores, borderColor: '#800020', tension:0.3, fill:true, backgroundColor:'rgba(128,0,32,0.1)' }] }
            });
        }

        async function deletar(tabela, id) {
            if(confirm("Excluir?")) {
                await sb.from(tabela).delete().eq('id', id);
                location.reload();
            }
        }

        function mudarAba(aba) {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-' + aba).classList.remove('hidden');
            document.getElementById('nav-' + aba).classList.add('active');
        }
    </script>
</body>
</html>

